---
title: "RE4B: CH 1.4 — Returning Values"
date: 2025-10-02
categories: [Reverse, Books]
tags: [Reverse, RE4B, Basics]
image: /assets/img/posts/ch1/ch_1.4.jpeg
---

<h1>1.4 Returning Values</h1>

<div dir="rtl" style="
  padding:12px 14px;
  margin:12px 0;
  border-radius:10px;
  border:1px solid rgba(34,211,238,.22);
  background:rgba(34,211,238,.07);
  line-height:1.9;
  color:#E5E7EB;">
  <ul style="margin:0; padding-right:18px;">
    <li>
      لما تعمل return 123; في دالة C الـcompiler بيحولها لكذا تعليمة بسيطة جدا
    </li>
    <br>
    <li>
      فكرة الـreturn (في أغلب المعماريات)
    </li>
    <li>
      1- حط قيمة الـreturn اللي هي 123 في register معين متفق عليه 
    </li>
    <li>
      2- اعمل تعليمة رجوع ترجع التنفيذ للـcaller
    </li>
    
  </ul>
  <hr>
</div>

<div dir="rtl" style="
  padding:12px 14px;
  margin:12px 0;
  border-radius:10px;
  border:1px solid rgba(249,115,22,.22);
  background:rgba(249,115,22,.07);
  line-height:1.9;
  color:#E5E7EB;">
  <h3> قبل ما نكمل... ايه هي الregister المتفق عليها؟ </h3>
  <ul style="margin:0; padding-right:18px;">
    <li>
    في x86 بنحط قيمة الـreturn في الـeax 
    لان هو الريجيستر اللي بيشيل الreturn value الخاصة x86
    </li>
    <li>
    في ARM الـ return register هو r0
    </li>
    <li>
    في MIPS الـ return register هو $v0 أو $2 هم نفس الregister بس فرق المسمي
    </li>
    <hr>
  </ul>
</div>


<div dir="rtl" style="
  padding:12px 14px;
  margin:12px 0;
  border-radius:10px;
  border:1px solid rgba(34,197,94,.18);
  background:rgba(34,197,94,.07);
  line-height:1.9;
  color:#E5E7EB;">
  <h3>طيب مين هو الـcaller ويعني ايه ؟</h3>
  <ul style="margin:0; padding-right:18px;">
    <li>الـ caller = الكود / الدالة اللي نادت الدالة</li>
    <li>ناخد مثال نوضح بيه </li> 
  </ul>
</div>

```c
int x = f();
```

<!--- نفس لون الدالة اللي قبلها --->
<div dir="rtl" style="
  padding:12px 14px;
  margin:12px 0;
  border-radius:10px;
  border:1px solid rgba(34,197,94,.18);
  background:rgba(34,197,94,.07);
  line-height:1.9;
  color:#E5E7EB;">
  <ul style="margin:0; padding-right:18px;">
    <li>الدالة هي "f()"</li>
    <li>السطر اللي فيه int x = f() هو الـcaller عشان نادي علي الدالة f</li> 
  </ul>
  <hr>
</div>



<div dir="rtl" style="
  padding:12px 14px;
  margin:12px 0;
  border-radius:10px;
  border:1px solid rgba(245,158,11,.22);
  background:rgba(245,158,11,.08);
  line-height:1.9;
  color:#E5E7EB;">
  <h3>يعني ايه "Returning Value" أصلا؟ </h3>
  <ul style="margin:0; padding-right:18px;">
    <li>	الدالة لما تخلص شغلها وترجع قيمة (return something;)</li>
    <li>لازم تسلّم النتيجة للـ caller (الكود اللي نادى الدالة)</li> 
    <li>	المعماريات كلها تقريبًا بتعمل ده بطريقة “اتفاقية” اسمها Calling Convention:</li>
    <li>هنحط فين قيمة الـ return؟ غالبا في Register ثابت معروف</li>
    <li>وإزاي نرجع؟ بتعليمة Return (أو Jump لعنوان الرجوع)</li>
  </ul>
  <hr>
</div>

<div dir="rtl">
  <h3>مثال C code اللي هنعمله reverseكامل</h3>
</div>

```c
int f()
{
  return 123;
}
```

<div dir="rtl">
  <h2>ايه اللي بيحصل علي x86</h2>
  <h3>الـ MSVC, GCC مع الـ Optimization بيطلعو </h3>
</div>

```c
mov eax, 123
ret
```

<div dir="rtl" style="
  padding:12px 14px;
  margin:12px 0;
  border-radius:10px;
  border:1px solid rgba(96,165,250,.22);
  background:rgba(96,165,250,.07);
  line-height:1.9;
  color:#E5E7EB;">
  <h3>نفككها واحدة واحدة: </h3>
  <h5> mov eax, 123 </h5>
  <ul style="margin:0; padding-right:18px;">
    <li>يعني "حط القيمة 123 في الـ eax register "</li>
    <li>وزي ما قولنا فوق ان الeax هو الـregister المتفق عليه في حمل الreturn value </li> 
  </ul>
  <h5> ret </h5>
  <ul style="margin:0; padding-right:18px;">
    <li>دي بتعمل رجوع للـ caller:</li>
    <li>عمليًا بتاخد عنوان الرجوع اللي كان محفوظ (عادة على الـ stack) وتكمل تنفيذ من بعد استدعاء الدالة</li>
    <h4>الخلاصة:</h4>
    <li>النتيجة في EAX => وبعدها RET => والـ caller يقرأ من EAX</li>
  </ul>
  <hr>
</div>


<div dir="rtl" style="
  padding:12px 14px;
  margin:12px 0;
  border-radius:10px;
  border:1px solid rgba(180,83,9,.22);
  background:rgba(180,83,9,.07);
  line-height:1.9;
  color:#E5E7EB;">
  <h2>جزئية مهمة:</h2>
  <ul style="margin:0; padding-right:18px;">
    <h4>يعني ايه الcaller يقرأ من الEAX ؟</h4>
    <li>يعني احنا حطينا القيمة في الـEAX بس مستخدمنهاش</li>
    <li>كإن EAX كرتونة مؤقتة الدالة حطت فيها النتيجة</li>
    <li>والـ caller رايح يفتح الكرتونة وياخد اللي فيه</li>
  </ul>
</div>


<div dir="rtl">
  <h2>نشوف الـInstruction الخاصة بـ ARM</h2>
  <h3>الـcompiler طلع output</h3>
</div>

```c
mov r0, #0x7b
bx lr
```

<div dir="rtl" style="
  padding:12px 14px;
  margin:12px 0;
  border-radius:10px;
  border:1px solid rgba(239,68,68,.20);
  background:rgba(239,68,68,.06);
  line-height:1.9;
  color:#E5E7EB;">
  <h3>نفس الفكرة بس التسمية مختلفة</h3>
  <ul style="margin:0; padding-right:18px;">
    <li>هنا الreturn register هو r0</li>
    <li>و bx lr معناها:"ارجع لعنوان موجود في LR"</li>
    <h4>تذكرة: "LR = link register"</h4>
  </ul>
  <hr>
</div>


<div dir="rtl">
  <h2>علي MPIS ايه اللي بيختلف؟</h2>
  <h3>الـcompiler طلع output</h3>
</div>

IDA

```c
jr $ra
li $v0, 0x7B
```

GCC

```c
j $31
li $2, 123
```

<div dir="rtl" style="
  padding:12px 14px;
  margin:12px 0;
  border-radius:10px;
  border:1px solid rgba(203,213,225,.18);
  background:rgba(203,213,225,.04);
  line-height:1.9;
  color:#E5E7EB;">
  <h3>لو أخدت بالك كود الـ assembly مقلوب </h3>
  <ul style="margin:0; padding-right:18px;">
    <li>يعني jump insruction مكتوبة الأول بعدها الـreturn عكس الـ ARM, x86</li>
    <h4>طب دا ليه؟ </h4>
    <li>في MIPS التعليمة اللي بعد القفزة بتتنفذ قبل القفزة نفسها </li>
    <li>فالـ compiler بيبدل أماكنهم عشان يستفيد من السلوك دا </li>
  </ul>
</div>


<div dir="rtl" style="
  padding:12px 14px;
  margin:12px 0;
  border-radius:10px;
  border:1px solid rgba(239,68,68,.20);
  background:rgba(239,68,68,.06);
  line-height:1.9;
  color:#E5E7EB;">
  <h4>ليه الكلام دا مهم في الـrevers engineering </h4>
  <ul style="margin:0; padding-right:18px;">
    <li>لما تشوف function صغيرة جدا في IDA أو ghidra </li>
    <li>لو لقيت mov eax, imm + ret </li>
    <li>اعرف ان دي الة بتعمل return ثابت</li>
    <li>ونفس الفكرة بالـ ARM, MIPS </li>
  </ul>
</div>












